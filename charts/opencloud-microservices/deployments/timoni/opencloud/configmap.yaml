apiVersion: v1
kind: Namespace
metadata:
  name: opencloud
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opencloud-config
  namespace: opencloud
data:
  ###############################################################################
  # Global Configuration
  ###############################################################################
  EXTERNAL_DOMAIN: "cloud.opencloud.test"
  TAG: ""

  ###############################################################################
  # Deployment Strategy
  ###############################################################################
  DEPLOY_TYPE: "RollingUpdate"
  MAX_SURGE: "25%"
  MAX_UNAV: "25%"

  OPENCLOUD_WEB_URL: "https://www.opencloud.eu"
  OPENCLOUD_LOGGING_LEVEL: "debug"

  ###############################################################################
  # Ingress
  ###############################################################################
  INGRESS_ENABLED: "false"
  INGRESS_CLASS_NAME: "nginx"
  INGRESS_PROXY_BODY_SIZE: "1024m"
  GATEWAY_HTTPROUTE_ENABLED: "true"

  ###############################################################################
  # Persistence StorageClass and AccessModes (global defaults)
  ###############################################################################
  PERSISTENCE_STORAGE_CLASS_NAME: ""
  # Comma-separated for runtime to split into a list, e.g. "ReadWriteMany" or "ReadWriteOnce,ReadOnlyMany"
  PERSISTENCE_ACCESS_MODES: "ReadWriteOnce"

  ###############################################################################
  # Persistence (service PVC sizes and toggles)
  ###############################################################################
  IDM_PERSISTENCE_ENABLED: "false"
  IDM_PERSISTENCE_SIZE: "10Gi"
  
  # NATS Configuration
  NATS_DEPLOY_TYPE: "RollingUpdate"
  NATS_MAX_SURGE: "25%"
  NATS_MAX_UNAV: "25%"
  NATS_PERSISTENCE_ENABLED: "false"
  NATS_PERSISTENCE_SIZE: "10Gi"
  
  OCM_PERSISTENCE_ENABLED: "false"
  OCM_PERSISTENCE_SIZE: "1Gi"
  ONLYOFFICE_PERSISTENCE_SIZE: "2Gi"
  SEARCH_PERSISTENCE_ENABLED: "true"
  SEARCH_PERSISTENCE_SIZE: "10Gi"
  STORAGE_USERS_BACKEND_DRIVER: "decomposed"
  STORAGE_SYSTEM_PERSISTENCE_ENABLED: "true"
  STORAGE_SYSTEM_PERSISTENCE_SIZE: "5Gi"
  STORAGE_USERS_PERSISTENCE_ENABLED: "true"
  STORAGE_USERS_PERSISTENCE_SIZE: "50Gi"
  THUMBNAILS_PERSISTENCE_ENABLED: "true"
  THUMBNAILS_PERSISTENCE_SIZE: "10Gi"
  WEB_PERSISTENCE_ENABLED: "true"
  WEB_PERSISTENCE_SIZE: "1Gi"

  # NATS specific persistence options
  # When true, a root init container will chown the NATS data volume before the main container starts.
  NATS_PERSISTENCE_CHOWN_INIT_CONTAINER: "false"
  
  ###############################################################################
  # Quotas
  ###############################################################################
  QUOTAS_DEFAULT: "0"
  QUOTAS_USER: "0"
  QUOTAS_SPACE_ADMIN: "0"

  ###############################################################################
  # Internal Keycloak (for testing only)
  ###############################################################################
  KEYCLOAK_DOMAIN: "keycloak.opencloud.test"
  KEYCLOAK_ENABLED: "true"

  ###############################################################################
  # Internal Minio (for testing only)
  ###############################################################################
  MINIO_DOMAIN: "minio.opencloud.test"
  MINIO_ENABLED: "false"
  MINIO_PERSISTENCE_SIZE: "40Gi"

  ###############################################################################
  # LDAP Configuration
  ###############################################################################
  LDAP_URI: "ldaps://openldap.openldap.svc.cluster.local:636"
  LDAP_WRITEABLE: "true"
  LDAP_INSECURE: "true"
  LDAP_BIND_DN: "cn=admin,dc=opencloud,dc=eu"
  LDAP_USER_NAME_MATCH: "none"
  LDAP_USER_SCHEMA_ID: "openCloudUUID"
  LDAP_GROUP_SCHEMA_ID: "openCloudUUID"

  ###############################################################################
  # OIDC Configuration
  ###############################################################################
  OIDC_ISSUER_URI: "https://keycloak.opencloud.test/realms/openCloud"
  EXTERNAL_USER_MANAGEMENT_ENABLED: "true"
  EXTERNAL_USER_MANAGEMENT_ADMIN_UUID: "0ab77e6d-23b4-4ba3-9843-a3b3efdcfc53"
  AUTOPROVISION_ACCOUNTS_ENABLED: "true"
  AUTOPROVISION_ACCOUNTS_CLAIM_USER_NAME: "sub"
  OIDC_USER_ID_CLAIM: "sub"
  OIDC_USER_ID_CLAIM_ATTRIBUTE_MAPPING: "username"
  OIDC_ROLE_ASSIGNMENT_CLAIM: "roles"
  OIDC_IDP_INSECURE: "true"
  OC_HTTP_API_INSECURE: "true"
  APPS_INTEGRATION_ENABLED: "true"
  WEB_OIDC_WEB_CLIENT_ID: "web"

  ###############################################################################
  # Search Configuration
  ###############################################################################
  SEARCH_EXTRACTOR_TYPE: "tika"

  ###############################################################################
  # Demo Users
  ###############################################################################
  DEMO_USERS_ENABLED: "false"

  ###############################################################################
  # Collabora Configuration
  ###############################################################################
  COLLABORA_ENABLED: "true"
  COLLABORA_URI: "https://collabora.opencloud.test"
  COLLABORA_DOMAIN: "collabora.opencloud.test"
  COLLABORA_TAG: "25.04.8.3.1"
  COLLABORA_ICON_URI: "https://collabora.opencloud.test/favicon.ico"
  COLLABORA_INSECURE: "true"
  COLLABORA_DISABLE_PROOF: "false"
  COLLABORA_INGRESS_ENABLED: "false"
  COLLABORA_INGRESS_CLASS_NAME: "nginx"
  COLLABORA_INGRESS_PROXY_BODY_SIZE: "1024m"

  ###############################################################################
  # OnlyOffice Configuration
  ###############################################################################
  ONLYOFFICE_ENABLED: "false"
  ONLYOFFICE_URI: "https://onlyoffice.opencloud.test"
  ONLYOFFICE_DOMAIN: "onlyoffice.opencloud.test"
  ONLYOFFICE_ICON_URI: "https://onlyoffice.opencloud.test/web-apps/apps/documenteditor/main/resources/img/favicon.ico"
  ONLYOFFICE_INSECURE: "true"
  ONLYOFFICE_DISABLE_PROOF: "false"
  ONLYOFFICE_INGRESS_ENABLED: "false"

  ###############################################################################
  # WOPI Configuration
  ###############################################################################
  WOPI_INGRESS_DOMAIN: "wopi.opencloud.test"

  ###############################################################################
  # Antivirus
  ###############################################################################
  ANTIVIRUS_ENABLED: "false"
  ANTIVIRUS_INFECTED_FILE_HANDLING: "abort"
  ANTIVIRUS_SCANNER_TYPE: "clamav"
  ANTIVIRUS_CLAMAV_SOCKET: "tcp://clamav.clamav.svc.cluster.local:3310"
  ANTIVIRUS_ICAP_URL: "http://clamav-icap.clamav:1344"
  ANTIVIRUS_ICAP_SERVICE: "avscan"

  ###############################################################################
  # SMTP Configuration
  ###############################################################################
  EMAIL_NOTIFICATIONS_ENABLED: "false"
  SMTP_HOST: ""
  SMTP_PORT: ""
  SMTP_SENDER: ""
  SMTP_AUTHENTICATION: "none"
  SMTP_ENCRYPTION: "ssltls"

  ###############################################################################
  # Policies
  ###############################################################################
  FEATURES_POLICIES_ENABLED: "true"
  FEATURES_POLICIES_PROXY_REGO: |
    package proxy

    import future.keywords.if
    import data.utils

    default granted := true

    granted = false if {
        input.request.method == "PUT"
        pathPrefixes := [
            "/dav",
            "/remote.php/webdav",
            "/remote.php/dav",
            "/webdav",
        ]
        restricted := pathPrefixes[_]
        startswith(input.request.path, restricted)
        utils.is_extension_restricted(input.resource.name)
    }

  FEATURES_POLICIES_POSTPROCESSING_REGO: |
    package postprocessing

    import future.keywords.if
    import data.utils

    default granted := true

    granted = false if {
        utils.is_extension_restricted(input.resource.name)
    }

    granted = false if {
        bytes := opencloud.resource.download(input.resource.url)
        mimetype := opencloud.mimetype.detect(bytes)
        utils.is_mimetype_restricted(mimetype)
    }

  FEATURES_POLICIES_UTILS_REGO: |
    package utils

    # For filename checking
    RESTRICTED_EXTENSIONS := {
        ".exe", ".dll", ".msi", ".scr", ".com", ".pif",
        ".bat", ".cmd", ".ps1", ".vbs", ".vbe", ".wsh"
    }

    # For mimetype checking
    RESTRICTED_EXTENSIONS_NO_DOT := {
        "exe", "dll", "msi", "scr", "com", "pif",
        "bat", "cmd", "ps1", "vbs", "vbe", "wsh"
    }

    # Direct MIME type check
    RESTRICTED_MIMETYPES := {
        "application/x-msdownload",
        "application/x-dosexec",
        "application/x-executable",
        "application/vnd.microsoft.portable-executable",
        "application/x-msi",
        "application/x-ms-dos-executable",
        "application/x-msdos-program",
        "application/x-bat",
        "application/bat",
        "application/x-sh",
        "application/x-shellscript"
    }

    # Check filename extension
    is_extension_restricted(identifier) {
        extension := RESTRICTED_EXTENSIONS[_]
        endswith(lower(identifier), extension)
    }

    # Check MIME type
    is_mimetype_restricted(mimetype) {
        RESTRICTED_MIMETYPES[mimetype]
    }

    is_mimetype_restricted(mimetype) {
        extensions := opencloud.mimetype.extensions(mimetype)
        ext := extensions[_]
        RESTRICTED_EXTENSIONS_NO_DOT[ext]
    }